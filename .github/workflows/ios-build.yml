name: Build iOS with Widget

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      # 1) Build the Flutter app normally (no widget involvement)
      - name: Build Flutter iOS App
        run: flutter build ios --release --no-codesign

      # 2) Build the widget extension as a standalone Xcode project
      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Widget Xcode Project
        run: |
          cd ios/RunnerWidget
          xcodegen generate
          cd ../..

      - name: Build Widget Extension
        run: |
          xcodebuild build \
            -project ios/RunnerWidget/RunnerWidget.xcodeproj \
            -scheme RunnerWidgetExtension \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build/widget-derived \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      # 3) Embed the widget into the app bundle and package
      - name: Package IPA with Widget
        run: |
          APP_PATH="build/ios/iphoneos/Runner.app"
          WIDGET_PATH=$(find build/widget-derived -name "RunnerWidgetExtension.appex" -type d | head -1)

          # Create PlugIns directory and embed the widget
          mkdir -p "$APP_PATH/PlugIns"
          cp -r "$WIDGET_PATH" "$APP_PATH/PlugIns/"

          # Package as IPA
          mkdir Payload
          cp -r "$APP_PATH" Payload/
          zip -r app-with-widgets.ipa Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: app-with-widgets
          path: app-with-widgets.ipa